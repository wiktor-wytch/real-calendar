"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("obsidian");function t(e,t,n,i){return new(n||(n=Promise))(function(a,s){function r(e){try{o(i.next(e))}catch(e){s(e)}}function l(e){try{o(i.throw(e))}catch(e){s(e)}}function o(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,l)}o((i=i.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class n extends e.MarkdownRenderChild{constructor(e,t,n){super(e),this.container=e,this.plugin=t,this.options=n,this.viewMode=n.view||"month";const i=new Date;this.currentDate=i,this.currentMonth=i.getMonth(),this.currentYear=i.getFullYear()}render(){this.container.empty();const e=this.container.createEl("div");e.addClass("real-calendar");const t=e.createEl("div",{cls:"calendar-controls"}),n=t.createEl("div",{cls:"calendar-header"}),i=n.createEl("button",{text:"◀"}),a=n.createEl("span"),s=n.createEl("button",{text:"▶"});n.createEl("button",{text:"Today"}).onclick=()=>{const e=new Date;this.currentDate=e,this.currentMonth=e.getMonth(),this.currentYear=e.getFullYear(),this.render()};const r=t.createEl("div",{cls:"view-toggle"}),l=r.createEl("button",{text:"Month"}),o=r.createEl("button",{text:"Week"}),d=r.createEl("button",{text:"Day"});if([l,o,d].forEach(e=>e.removeClass("active")),"month"===this.viewMode?l.addClass("active"):"week"===this.viewMode?o.addClass("active"):d.addClass("active"),l.onclick=()=>{this.viewMode="month",this.render()},o.onclick=()=>{this.viewMode="week",this.render()},d.onclick=()=>{this.viewMode="day",this.render()},"month"===this.viewMode)a.setText(`${this.plugin.getMonthName(this.currentMonth)} ${this.currentYear}`),i.onclick=()=>{this.currentMonth--,this.currentMonth<0&&(this.currentMonth=11,this.currentYear--),this.currentDate=new Date(this.currentYear,this.currentMonth,1),this.render()},s.onclick=()=>{this.currentMonth++,this.currentMonth>11&&(this.currentMonth=0,this.currentYear++),this.currentDate=new Date(this.currentYear,this.currentMonth,1),this.render()},this.renderMonthView(e);else if("week"===this.viewMode){const t=this.plugin.getWeekStart(this.currentDate),n=new Date(t);n.setDate(n.getDate()+6),a.setText(`${this.plugin.getMonthName(t.getMonth())} ${t.getDate()} - ${this.plugin.getMonthName(n.getMonth())} ${n.getDate()}, ${n.getFullYear()}`),i.onclick=()=>{this.currentDate.setDate(this.currentDate.getDate()-7),this.currentMonth=this.currentDate.getMonth(),this.currentYear=this.currentDate.getFullYear(),this.render()},s.onclick=()=>{this.currentDate.setDate(this.currentDate.getDate()+7),this.currentMonth=this.currentDate.getMonth(),this.currentYear=this.currentDate.getFullYear(),this.render()},this.renderWeekView(e)}else a.setText(`${this.plugin.getDayName(this.currentDate.getDay())}, ${this.plugin.getMonthName(this.currentDate.getMonth())} ${this.currentDate.getDate()}, ${this.currentDate.getFullYear()}`),i.onclick=()=>{this.currentDate.setDate(this.currentDate.getDate()-1),this.currentMonth=this.currentDate.getMonth(),this.currentYear=this.currentDate.getFullYear(),this.render()},s.onclick=()=>{this.currentDate.setDate(this.currentDate.getDate()+1),this.currentMonth=this.currentDate.getMonth(),this.currentYear=this.currentDate.getFullYear(),this.render()},this.renderDayView(e)}refresh(){this.render()}onunload(){const e=this.plugin.embedRenderers.indexOf(this);e>-1&&this.plugin.embedRenderers.splice(e,1)}getFilteredEvents(e){let t=this.plugin.events.filter(t=>t.date===e);return this.options.folder&&(t=t.filter(e=>e.file.path.startsWith(this.options.folder))),!1===this.options.showCompleted&&(t=t.filter(e=>!e.done)),t.sort((e,t)=>(e.startTime||"").localeCompare(t.startTime||""))}addDeleteContextMenu(n,i){n.oncontextmenu=n=>t(this,void 0,void 0,function*(){n.preventDefault();const a=new e.Menu;a.addItem(n=>n.setTitle("Move to Trash").setIcon("trash").onClick(()=>t(this,void 0,void 0,function*(){try{yield this.plugin.app.vault.trash(i,!0),new e.Notice(`Moved "${i.basename}" to trash`)}catch(t){console.error("Error trashing file:",t),new e.Notice("Failed to move file to trash.")}}))),a.showAtMouseEvent(n)})}renderMonthView(e){const t=1===this.plugin.settings.weekStartDay?["Mo","Tu","We","Th","Fr","Sa","Su"]:["Su","Mo","Tu","We","Th","Fr","Sa"],n=e.createEl("div",{cls:"calendar-weekdays"});t.forEach(e=>n.createEl("div",{cls:"calendar-weekday",text:e}));const i=e.createEl("div",{cls:"calendar-grid"}),a=new Date(this.currentYear,this.currentMonth,1).getDay(),s=new Date(this.currentYear,this.currentMonth+1,0).getDate(),r=new Date,l=`${r.getFullYear()}-${(r.getMonth()+1).toString().padStart(2,"0")}-${r.getDate().toString().padStart(2,"0")}`;let o=1===this.plugin.settings.weekStartDay?0===a?6:a-1:a;for(let e=0;e<o;e++)i.createEl("div",{cls:"calendar-day empty"});for(let e=1;e<=s;e++){const t=`${this.currentYear}-${(this.currentMonth+1).toString().padStart(2,"0")}-${e.toString().padStart(2,"0")}`,n=i.createEl("div",{cls:"calendar-day"});t===l&&n.addClass("today"),n.createEl("div",{cls:"day-label",text:e.toString()});this.getFilteredEvents(t).forEach(e=>{const t=e.startTime?`${e.startTime} ${e.title}`:e.title,i=n.createEl("div",{cls:"calendar-event",text:t});i.setAttribute("title",e.title),i.onclick=()=>this.plugin.app.workspace.openLinkText(e.file.path,"",!1),e.done?i.addClass("event-done"):e.date<l?i.addClass("event-overdue"):i.addClass("event-upcoming"),this.addDeleteContextMenu(i,e.file)})}}renderWeekView(e){const t=e.createEl("div",{cls:"week-view"}),n=this.plugin.getWeekStart(this.currentDate),i=new Date,a=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`;for(let e=0;e<7;e++){const i=new Date(n);i.setDate(i.getDate()+e);const s=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`,r=t.createEl("div",{cls:"week-day"});r.createEl("div",{cls:"week-day-header"}).setText(`${this.plugin.getDayName(i.getDay())}, ${this.plugin.getMonthName(i.getMonth())} ${i.getDate()}`),s===a&&r.addClass("today");const l=r.createEl("div",{cls:"week-day-events"}),o=this.getFilteredEvents(s);0===o.length?l.createEl("div",{text:"No events",cls:"calendar-event empty-event"}):o.forEach(e=>{const t=e.startTime?`${e.startTime} ${e.title}`:e.title,n=l.createEl("div",{cls:"calendar-event",text:t});n.setAttribute("title",e.title),n.onclick=()=>this.plugin.app.workspace.openLinkText(e.file.path,"",!1),e.done?n.addClass("event-done"):e.date<a?n.addClass("event-overdue"):n.addClass("event-upcoming"),this.addDeleteContextMenu(n,e.file)})}}renderDayView(e){const t=e.createEl("div",{cls:"day-view"}),n=`${this.currentDate.getFullYear()}-${(this.currentDate.getMonth()+1).toString().padStart(2,"0")}-${this.currentDate.getDate().toString().padStart(2,"0")}`,i=new Date,a=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`,s=t.createEl("div",{cls:"day-event-list"}),r=this.getFilteredEvents(n);0===r.length?s.createEl("div",{cls:"day-no-events",text:"No events for this day"}):r.forEach(e=>{const t=s.createEl("div",{cls:"day-event-item"});if(t.onclick=()=>this.plugin.app.workspace.openLinkText(e.file.path,"",!1),t.createEl("div",{cls:"day-event-title",text:e.title}),e.startTime||e.endTime){const n=t.createEl("div",{cls:"day-event-time"});e.startTime&&e.endTime?n.setText(`${e.startTime} - ${e.endTime}`):e.startTime?n.setText(`${e.startTime}`):e.endTime&&n.setText(`Until ${e.endTime}`)}const n=t.createEl("div",{cls:"day-event-status"});e.done?(n.setText("✓ Completed"),n.addClass("event-done")):e.date<a&&(n.setText("⚠ Overdue"),n.addClass("event-overdue")),this.addDeleteContextMenu(t,e.file)})}}class i extends e.ItemView{constructor(e,t){super(e),this.plugin=t}getViewType(){return c}getDisplayText(){return"Real Calendar"}getIcon(){return"calendar-with-checkmark"}onOpen(){return t(this,void 0,void 0,function*(){this.renderLoadingState(),yield this.plugin.ensureInitialized(),this.renderCalendar()})}renderLoadingState(){const e=this.contentEl;e.empty(),e.createEl("div",{cls:"real-calendar-loading",text:"Loading calendar events..."})}addDeleteContextMenu(n,i){n.oncontextmenu=n=>t(this,void 0,void 0,function*(){n.preventDefault();const a=new e.Menu;a.addItem(n=>n.setTitle("Move to Trash").setIcon("trash").onClick(()=>t(this,void 0,void 0,function*(){try{yield this.plugin.app.vault.trash(i,!0),new e.Notice(`Moved "${i.basename}" to trash`)}catch(t){console.error("Error trashing file:",t),new e.Notice("Failed to move file to trash.")}}))),a.showAtMouseEvent(n)})}renderCalendar(){const e=this.contentEl;e.empty();const t=e.createEl("div");t.addClass("real-calendar");const n=t.createEl("div",{cls:"calendar-controls"}),i=n.createEl("div",{cls:"calendar-header"}),a=i.createEl("button",{text:"◀"}),s=i.createEl("span"),r=i.createEl("button",{text:"▶"});i.createEl("button",{text:"Today"}).onclick=()=>{const e=new Date;this.plugin.currentDate=e,this.plugin.currentMonth=e.getMonth(),this.plugin.currentYear=e.getFullYear(),this.renderCalendar()};const l=n.createEl("div",{cls:"view-toggle"}),o=l.createEl("button",{text:"Month"}),d=l.createEl("button",{text:"Week"}),c=l.createEl("button",{text:"Day"});if([o,d,c].forEach(e=>e.removeClass("active")),"month"===this.plugin.viewMode?o.addClass("active"):"week"===this.plugin.viewMode?d.addClass("active"):c.addClass("active"),o.onclick=()=>{this.plugin.viewMode="month",this.renderCalendar()},d.onclick=()=>{this.plugin.viewMode="week",this.renderCalendar()},c.onclick=()=>{this.plugin.viewMode="day",this.renderCalendar()},"month"===this.plugin.viewMode)s.setText(`${this.plugin.getMonthName(this.plugin.currentMonth)} ${this.plugin.currentYear}`),a.onclick=()=>{this.plugin.currentMonth--,this.plugin.currentMonth<0&&(this.plugin.currentMonth=11,this.plugin.currentYear--),this.plugin.currentDate=new Date(this.plugin.currentYear,this.plugin.currentMonth,1),this.renderCalendar()},r.onclick=()=>{this.plugin.currentMonth++,this.plugin.currentMonth>11&&(this.plugin.currentMonth=0,this.plugin.currentYear++),this.plugin.currentDate=new Date(this.plugin.currentYear,this.plugin.currentMonth,1),this.renderCalendar()},this.renderMonthView(t);else if("week"===this.plugin.viewMode){const e=this.plugin.getWeekStart(this.plugin.currentDate),n=new Date(e);n.setDate(n.getDate()+6),s.setText(`${this.plugin.getMonthName(e.getMonth())} ${e.getDate()} - ${this.plugin.getMonthName(n.getMonth())} ${n.getDate()}, ${n.getFullYear()}`),a.onclick=()=>{this.plugin.currentDate.setDate(this.plugin.currentDate.getDate()-7),this.plugin.currentMonth=this.plugin.currentDate.getMonth(),this.plugin.currentYear=this.plugin.currentDate.getFullYear(),this.renderCalendar()},r.onclick=()=>{this.plugin.currentDate.setDate(this.plugin.currentDate.getDate()+7),this.plugin.currentMonth=this.plugin.currentDate.getMonth(),this.plugin.currentYear=this.plugin.currentDate.getFullYear(),this.renderCalendar()},this.renderWeekView(t)}else s.setText(`${this.plugin.getDayName(this.plugin.currentDate.getDay())}, ${this.plugin.getMonthName(this.plugin.currentDate.getMonth())} ${this.plugin.currentDate.getDate()}, ${this.plugin.currentDate.getFullYear()}`),a.onclick=()=>{this.plugin.currentDate.setDate(this.plugin.currentDate.getDate()-1),this.plugin.currentMonth=this.plugin.currentDate.getMonth(),this.plugin.currentYear=this.plugin.currentDate.getFullYear(),this.renderCalendar()},r.onclick=()=>{this.plugin.currentDate.setDate(this.plugin.currentDate.getDate()+1),this.plugin.currentMonth=this.plugin.currentDate.getMonth(),this.plugin.currentYear=this.plugin.currentDate.getFullYear(),this.renderCalendar()},this.renderDayView(t)}renderMonthView(e){const t=1===this.plugin.settings.weekStartDay?["Mo","Tu","We","Th","Fr","Sa","Su"]:["Su","Mo","Tu","We","Th","Fr","Sa"],n=e.createEl("div",{cls:"calendar-weekdays"});t.forEach(e=>n.createEl("div",{cls:"calendar-weekday",text:e}));const i=e.createEl("div",{cls:"calendar-grid"}),a=new Date(this.plugin.currentYear,this.plugin.currentMonth,1).getDay(),s=new Date(this.plugin.currentYear,this.plugin.currentMonth+1,0).getDate(),r=new Date,l=`${r.getFullYear()}-${(r.getMonth()+1).toString().padStart(2,"0")}-${r.getDate().toString().padStart(2,"0")}`;let o=1===this.plugin.settings.weekStartDay?0===a?6:a-1:a;for(let e=0;e<o;e++)i.createEl("div",{cls:"calendar-day empty"});for(let e=1;e<=s;e++){const t=`${this.plugin.currentYear}-${(this.plugin.currentMonth+1).toString().padStart(2,"0")}-${e.toString().padStart(2,"0")}`,n=i.createEl("div",{cls:"calendar-day"});t===l&&n.addClass("today"),n.createEl("div",{cls:"day-label",text:e.toString()});this.plugin.events.filter(e=>e.date===t).sort((e,t)=>(e.startTime||"").localeCompare(t.startTime||"")).forEach(e=>{const t=e.startTime?`${e.startTime} ${e.title}`:e.title,i=n.createEl("div",{cls:"calendar-event",text:t});i.setAttribute("title",e.title),i.onclick=()=>this.app.workspace.openLinkText(e.file.path,"",!1),e.done?i.addClass("event-done"):e.date<l?i.addClass("event-overdue"):i.addClass("event-upcoming"),this.addDeleteContextMenu(i,e.file)})}}renderWeekView(e){const t=e.createEl("div",{cls:"week-view"}),n=this.plugin.getWeekStart(this.plugin.currentDate),i=new Date,a=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`;for(let e=0;e<7;e++){const i=new Date(n);i.setDate(i.getDate()+e);const s=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`,r=t.createEl("div",{cls:"week-day"});r.createEl("div",{cls:"week-day-header"}).setText(`${this.plugin.getDayName(i.getDay())}, ${this.plugin.getMonthName(i.getMonth())} ${i.getDate()}`),s===a&&r.addClass("today");const l=r.createEl("div",{cls:"week-day-events"}),o=this.plugin.events.filter(e=>e.date===s).sort((e,t)=>(e.startTime||"").localeCompare(t.startTime||""));0===o.length?l.createEl("div",{text:"No events",cls:"calendar-event empty-event"}):o.forEach(e=>{const t=e.startTime?`${e.startTime} ${e.title}`:e.title,n=l.createEl("div",{cls:"calendar-event",text:t});n.setAttribute("title",e.title),n.onclick=()=>this.app.workspace.openLinkText(e.file.path,"",!1),e.done?n.addClass("event-done"):e.date<a?n.addClass("event-overdue"):n.addClass("event-upcoming"),this.addDeleteContextMenu(n,e.file)})}}renderDayView(e){const t=e.createEl("div",{cls:"day-view"}),n=`${this.plugin.currentDate.getFullYear()}-${(this.plugin.currentDate.getMonth()+1).toString().padStart(2,"0")}-${this.plugin.currentDate.getDate().toString().padStart(2,"0")}`,i=new Date,a=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`,s=t.createEl("div",{cls:"day-event-list"}),r=this.plugin.events.filter(e=>e.date===n).sort((e,t)=>(e.startTime||"").localeCompare(t.startTime||""));0===r.length?s.createEl("div",{cls:"day-no-events",text:"No events for this day"}):r.forEach(e=>{const t=s.createEl("div",{cls:"day-event-item"});if(t.onclick=()=>this.app.workspace.openLinkText(e.file.path,"",!1),t.createEl("div",{cls:"day-event-title",text:e.title}),e.startTime||e.endTime){const n=t.createEl("div",{cls:"day-event-time"});e.startTime&&e.endTime?n.setText(`${e.startTime} - ${e.endTime}`):e.startTime?n.setText(`${e.startTime}`):e.endTime&&n.setText(`Until ${e.endTime}`)}const n=t.createEl("div",{cls:"day-event-status"});e.done?(n.setText("✓ Completed"),n.addClass("event-done")):e.date<a&&(n.setText("⚠ Overdue"),n.addClass("event-overdue")),this.addDeleteContextMenu(t,e.file)})}}class a extends e.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){const{containerEl:n}=this;n.empty(),new e.Setting(n).setName("Real Calendar Settings").setHeading(),new e.Setting(n).setName("Event folder").setDesc("Folder where event files are stored (e.g., 'Actions/Events' or 'Calendar'). Leave empty to scan all folders.").addText(n=>n.setPlaceholder("Actions/Events").setValue(this.plugin.settings.eventFolder).onChange(n=>t(this,void 0,void 0,function*(){const t=e.normalizePath(n.trim());this.plugin.settings.eventFolder=t,yield this.plugin.saveSettings()}))),new e.Setting(n).setName("Week starts on").setDesc("Choose which day starts the week in calendar views").addDropdown(e=>e.addOption("0","Sunday").addOption("1","Monday").setValue(this.plugin.settings.weekStartDay.toString()).onChange(e=>t(this,void 0,void 0,function*(){this.plugin.settings.weekStartDay=parseInt(e),yield this.plugin.saveSettings(),this.plugin.refreshCalendarView()}))),new e.Setting(n).setName("Rescan vault").setDesc("Force a full rescan of the vault to reload all events.").addButton(e=>e.setButtonText("Rescan now").setCta().onClick(()=>t(this,void 0,void 0,function*(){e.setButtonText("Scanning..."),e.setDisabled(!0),yield this.plugin.rescanVault(),this.plugin.refreshCalendarView(),e.setButtonText("Done!"),setTimeout(()=>{e.setButtonText("Rescan now"),e.setDisabled(!1)},2e3)}))),new e.Setting(n).setName("Frontmatter customization").setHeading(),n.createDiv({cls:"setting-item-description"}).createEl("p",{text:"Customize which fields appear in the frontmatter of new events and their order."}),new e.Setting(n).setName("Include 'done' field").setDesc("Track completion status of events").addToggle(e=>e.setValue(this.plugin.settings.frontmatterFields.done).onChange(e=>t(this,void 0,void 0,function*(){this.plugin.settings.frontmatterFields.done=e,yield this.plugin.saveSettings()}))),new e.Setting(n).setName("Field order").setHeading(),n.createDiv({cls:"setting-item-description"}).createEl("p",{text:"Drag to reorder how fields appear in the frontmatter."});const i=n.createDiv({cls:"real-calendar-field-order"});this.renderFieldOrder(i),new e.Setting(n).setName("How to use").setHeading(),n.createEl("p",{text:"Create event files with the following frontmatter:"});const a=n.createEl("pre",{cls:"real-calendar-example"});let s="---\n";for(const e of this.plugin.settings.fieldOrder)if(this.plugin.settings.frontmatterFields[e])switch(e){case"tags":s+="tags: event\n";break;case"date":s+="date: 2025-10-24\n";break;case"startTime":s+='startTime: "14:00"\n';break;case"endTime":s+='endTime: "15:30"\n';break;case"done":s+="done: false\n"}s+="---",a.textContent=s,n.createEl("p",{text:'Or use the command "Real Calendar: Create new event"'}),n.createEl("p",{text:"Fields:"});const r=n.createEl("ul"),l=r.createEl("li");l.createEl("strong",{text:"tags: event"}),l.appendText(" - Required. Must include 'event' tag.");const o=r.createEl("li");o.createEl("strong",{text:"date"}),o.appendText(" - Required. Format: YYYY-MM-DD");const d=r.createEl("li");d.createEl("strong",{text:"startTime"}),d.appendText(" - Optional. Format: HH:MM (in quotes)");const c=r.createEl("li");c.createEl("strong",{text:"endTime"}),c.appendText(" - Optional. Format: HH:MM (in quotes)");const h=r.createEl("li");h.createEl("strong",{text:"done"}),h.appendText(" - Optional. Set to true to mark as completed."),new e.Setting(n).setName("Embedding calendars").setHeading(),n.createEl("p",{text:"You can embed the calendar in any note using a code block:"});n.createEl("pre",{cls:"real-calendar-example"}).textContent="```real-calendar\nview: month\nshowCompleted: false\nfolder: projects/events\n```",n.createEl("p",{text:"Embed options:"});const u=n.createEl("ul"),g=u.createEl("li");g.createEl("strong",{text:"view"}),g.appendText(" - month, week, or day");const p=u.createEl("li");p.createEl("strong",{text:"showCompleted"}),p.appendText(" - true or false (filters out completed events)");const v=u.createEl("li");v.createEl("strong",{text:"folder"}),v.appendText(" - Filter events to a specific folder")}renderFieldOrder(e){e.empty();const n={tags:"Tags",date:"Date",startTime:"Start time",endTime:"End time",done:"Done"};this.plugin.settings.fieldOrder.forEach((i,a)=>{const s=e.createDiv({cls:"real-calendar-field-item"});s.createSpan({text:"⋮⋮",cls:"drag-handle"}),s.createSpan({text:n[i]||i,cls:"field-name"});const r=s.createDiv({cls:"field-buttons"});if(a>0){r.createEl("button",{text:"↑",cls:"field-move-button"}).onclick=()=>t(this,void 0,void 0,function*(){const t=this.plugin.settings.fieldOrder[a];this.plugin.settings.fieldOrder[a]=this.plugin.settings.fieldOrder[a-1],this.plugin.settings.fieldOrder[a-1]=t,yield this.plugin.saveSettings(),this.renderFieldOrder(e)})}if(a<this.plugin.settings.fieldOrder.length-1){r.createEl("button",{text:"↓",cls:"field-move-button"}).onclick=()=>t(this,void 0,void 0,function*(){const t=this.plugin.settings.fieldOrder[a];this.plugin.settings.fieldOrder[a]=this.plugin.settings.fieldOrder[a+1],this.plugin.settings.fieldOrder[a+1]=t,yield this.plugin.saveSettings(),this.renderFieldOrder(e)})}s.draggable=!0,s.ondragstart=e=>{e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",a.toString()),s.addClass("dragging")},s.ondragend=()=>{s.removeClass("dragging")},s.ondragover=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},s.ondrop=n=>t(this,void 0,void 0,function*(){n.preventDefault();const t=parseInt(n.dataTransfer.getData("text/plain")),i=a;if(t!==i){const n=this.plugin.settings.fieldOrder[t];this.plugin.settings.fieldOrder.splice(t,1),this.plugin.settings.fieldOrder.splice(i,0,n),yield this.plugin.saveSettings(),this.renderFieldOrder(e)}})})}}function s(e){return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}function r(e){const t=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!t)return null;const n=parseInt(t[1],10),i=parseInt(t[2],10)-1,a=parseInt(t[3],10);if(i<0||i>11)return null;if(a<1||a>31)return null;const s=new Date(n,i,a);return s.getFullYear()!==n||s.getMonth()!==i||s.getDate()!==a?null:s}function l(e){const t=e.match(/^(\d{2}):(\d{2})$/);if(!t)return!1;const n=parseInt(t[1],10),i=parseInt(t[2],10);return n>=0&&n<=23&&i>=0&&i<=59}class o extends e.Modal{constructor(e,t){super(e),this.eventName="",this.eventDate="",this.startTime="",this.endTime="",this.plugin=t,this.eventDate=s(new Date)}onOpen(){const{contentEl:n}=this;n.empty(),n.createEl("h2",{text:"Create New Event"}),new e.Setting(n).setName("Event name").setDesc("Name of the event").addText(e=>{e.setPlaceholder("Team meeting").setValue(this.eventName).onChange(e=>{this.eventName=e}),setTimeout(()=>e.inputEl.focus(),10)}),new e.Setting(n).setName("Date").setDesc("Date of the event").addText(e=>{e.setPlaceholder("YYYY-MM-DD").setValue(this.eventDate).onChange(e=>{this.eventDate=e}),e.inputEl.type="date"}),new e.Setting(n).setName("Start time (optional)").setDesc("Leave empty for all-day event").addText(e=>{e.setPlaceholder("HH:MM").setValue(this.startTime).onChange(e=>{this.startTime=e}),e.inputEl.type="time"}),new e.Setting(n).setName("End time (optional)").setDesc("Leave empty for all-day event").addText(e=>{e.setPlaceholder("HH:MM").setValue(this.endTime).onChange(e=>{this.endTime=e}),e.inputEl.type="time"});const i=n.createDiv({cls:"modal-button-container"});i.createEl("button",{text:"Cancel"}).onclick=()=>this.close();i.createEl("button",{text:"Create Event",cls:"mod-cta"}).onclick=()=>t(this,void 0,void 0,function*(){yield this.createEvent()}),n.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.createEvent())})}createEvent(){return t(this,void 0,void 0,function*(){var t,n;if(this.eventName.trim())if(this.eventDate.trim())if(null!==r(this.eventDate))if(!this.startTime||l(this.startTime))if(!this.endTime||l(this.endTime))if(!this.startTime||!this.endTime||(t=this.startTime,n=this.endTime,l(t)&&l(n)&&t<n))try{let t="---\n";for(const e of this.plugin.settings.fieldOrder)if(this.plugin.settings.frontmatterFields[e])switch(e){case"tags":t+="tags: event\n";break;case"date":t+=`date: ${this.eventDate}\n`;break;case"startTime":this.startTime&&(t+=`startTime: "${this.startTime}"\n`);break;case"endTime":this.endTime&&(t+=`endTime: "${this.endTime}"\n`);break;case"done":t+="done: false\n"}t+="---\n";const n=e.normalizePath(this.plugin.settings.eventFolder||"");let i=this.eventName.trim().replace(/[\\/:*?"<>|]/g,"-"),a=n?e.normalizePath(`${n}/${i}.md`):`${i}.md`,s=1;for(;this.app.vault.getAbstractFileByPath(a);){const t=`${i}-${s}`;a=n?e.normalizePath(`${n}/${t}.md`):`${t}.md`,s++}if(n){this.app.vault.getAbstractFileByPath(n)||(yield this.app.vault.createFolder(n))}const r=(yield this.app.vault.create(a,t)).basename;r!==this.eventName?new e.Notice(`Event created as "${r}" (original name already existed)`):new e.Notice(`Event "${this.eventName}" created!`),this.close()}catch(t){console.error("Error creating event:",t),new e.Notice("Error creating event. The file might already exist.")}else new e.Notice("End time must be after start time");else new e.Notice("Invalid end time. Use HH:MM (00:00 - 23:59)");else new e.Notice("Invalid start time. Use HH:MM (00:00 - 23:59)");else new e.Notice("Invalid date. Please check month and day values.");else new e.Notice("Please enter a date");else new e.Notice("Please enter an event name")})}onClose(){const{contentEl:e}=this;e.empty()}}const d={eventFolder:"",weekStartDay:0,frontmatterFields:{tags:!0,date:!0,startTime:!0,endTime:!0,done:!0},fieldOrder:["tags","date","startTime","endTime","done"]},c="real-calendar-view";class h extends e.Plugin{constructor(){super(...arguments),this.events=[],this.currentMonth=(new Date).getMonth(),this.currentYear=(new Date).getFullYear(),this.currentDate=new Date,this.viewMode="month",this.refreshTimeout=null,this.isInitialized=!1,this.loadPromise=null,this.embedRenderers=[]}onload(){return t(this,void 0,void 0,function*(){yield this.loadSettings(),this.registerView(c,e=>new i(e,this)),this.addRibbonIcon("calendar-with-checkmark","Open Calendar",()=>t(this,void 0,void 0,function*(){yield this.ensureInitialized(),this.currentDate=new Date(this.currentYear,this.currentMonth,(new Date).getDate()),this.openCalendarView()})),this.registerEvent(this.app.vault.on("modify",t=>{this.isInitialized&&t instanceof e.TFile&&"md"===t.extension&&this.updateSingleFile(t)})),this.registerEvent(this.app.vault.on("create",t=>{this.isInitialized&&t instanceof e.TFile&&"md"===t.extension&&this.updateSingleFile(t)})),this.registerEvent(this.app.vault.on("delete",t=>{this.isInitialized&&t instanceof e.TFile&&"md"===t.extension&&this.removeFileEvent(t)})),this.registerEvent(this.app.vault.on("rename",()=>{this.isInitialized&&this.debouncedRefresh()})),this.addCommand({id:"create-event",name:"Create new event",callback:()=>{new o(this.app,this).open()}}),this.addSettingTab(new a(this.app,this)),this.registerMarkdownCodeBlockProcessor("real-calendar",(e,i,a)=>t(this,void 0,void 0,function*(){yield this.ensureInitialized();const t=this.parseEmbedOptions(e),s=i.createDiv({cls:"real-calendar-embed"}),r=new n(s,this,t);this.embedRenderers.push(r),a.addChild(r),r.render()})),this.app.workspace.onLayoutReady(()=>{this.backgroundInit()})})}parseEmbedOptions(t){const n={};try{const i=e.parseYaml(t);i&&("month"!==i.view&&"week"!==i.view&&"day"!==i.view||(n.view=i.view),"boolean"==typeof i.showCompleted&&(n.showCompleted=i.showCompleted),i.folder&&(n.folder=i.folder))}catch(e){console.warn("Could not parse embed options:",e)}return n}loadSettings(){return t(this,void 0,void 0,function*(){this.settings=Object.assign({},d,yield this.loadData()),this.settings.fieldOrder&&0!==this.settings.fieldOrder.length||(this.settings.fieldOrder=["tags","date","startTime","endTime","done"])})}saveSettings(){return t(this,void 0,void 0,function*(){yield this.saveData(this.settings)})}backgroundInit(){return t(this,void 0,void 0,function*(){try{yield this.loadEvents(),this.isInitialized=!0,console.log("Calendar background initialization complete"),this.refreshCalendarView()}catch(e){console.error("Calendar background init failed:",e)}})}ensureInitialized(){return t(this,void 0,void 0,function*(){this.isInitialized||(this.loadPromise||(this.loadPromise=this.loadEvents().then(()=>{this.isInitialized=!0,this.loadPromise=null})),yield this.loadPromise)})}debouncedRefresh(){this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout(()=>t(this,void 0,void 0,function*(){yield this.rescanVault(),this.refreshCalendarView()}),1e4)}isInEventFolder(e){return!this.settings.eventFolder||e.startsWith(this.settings.eventFolder)}loadEvents(){return t(this,arguments,void 0,function*(e=!1){var t;if(e||!(this.events.length>0)){try{const e=yield this.loadData();if((null==e?void 0:e.events)&&Array.isArray(e.events)){const n=[];for(const i of e.events){const e=this.app.vault.getAbstractFileByPath(null===(t=i.file)||void 0===t?void 0:t.path);e&&this.isInEventFolder(e.path)&&n.push(Object.assign(Object.assign({},i),{file:e}))}return this.events=n,console.log(`Loaded ${this.events.length} cached events from ${this.settings.eventFolder||"all folders"}`),void(this.events.length>0?this.validateCacheInBackground():yield this.rescanVault())}}catch(e){console.warn("No cached event data found:",e)}yield this.rescanVault()}})}validateCacheInBackground(){return t(this,void 0,void 0,function*(){setTimeout(()=>t(this,void 0,void 0,function*(){(yield this.checkForStaleCache())&&(console.log("Cache stale, rescanning vault"),yield this.rescanVault(),this.refreshCalendarView())}),3e3)})}checkForStaleCache(){return t(this,void 0,void 0,function*(){const e=this.app.vault.getMarkdownFiles().filter(e=>this.isInEventFolder(e.path)),t=new Set(e.map(e=>e.path)),n=new Set(this.events.map(e=>e.file.path));if(t.size!==n.size)return!0;for(const e of t)if(!n.has(e))return!0;return!1})}rescanVault(){return t(this,void 0,void 0,function*(){const e=this.app.vault.getMarkdownFiles().filter(e=>this.isInEventFolder(e.path)),t=[];for(let n=0;n<e.length;n+=20){const i=e.slice(n,n+20),a=yield Promise.all(i.map(e=>this.extractEventFromFile(e)));for(const e of a)e&&t.push(e)}this.events=t,yield this.saveData(Object.assign(Object.assign({},this.settings),{events:this.events})),console.log(`Vault scanned: ${t.length} events loaded from ${this.settings.eventFolder||"all folders"}`)})}updateSingleFile(n){return t(this,void 0,void 0,function*(){if(n instanceof e.TFile&&n.path.endsWith(".md")&&this.isInEventFolder(n.path))try{const e=yield this.extractEventFromFile(n),t=this.events.findIndex(e=>e.file.path===n.path);e?t>=0?this.events[t]=e:this.events.push(e):t>=0&&this.events.splice(t,1),yield this.saveData(Object.assign(Object.assign({},this.settings),{events:this.events})),this.refreshCalendarView()}catch(e){console.error("Error updating event:",n.path,e)}})}removeFileEvent(t){if(!(t instanceof e.TFile))return;const n=this.events.length;this.events=this.events.filter(e=>e.file.path!==t.path),this.events.length!==n&&(this.saveData(Object.assign(Object.assign({},this.settings),{events:this.events})),this.refreshCalendarView())}extractEventFromFile(n){return t(this,void 0,void 0,function*(){var t;try{const i=(yield this.app.vault.read(n)).match(/^-{3}\s*([\s\S]+?)\s*-{3}/);if(!i)return null;const a=e.parseYaml(i[1]);if(!(null===(t=null==a?void 0:a.tags)||void 0===t?void 0:t.includes("event")))return null;if(!a.date)return null;let l;if(a.date instanceof Date)l=s(a.date);else{if("string"!=typeof a.date)return null;l=a.date.trim()}return r(l)?{date:l,title:n.basename,file:n,done:!!a.done,startTime:a.startTime?String(a.startTime).trim():void 0,endTime:a.endTime?String(a.endTime).trim():void 0}:null}catch(e){return null}})}openCalendarView(){return t(this,void 0,void 0,function*(){const e=this.app.workspace.getLeavesOfType(c);if(e.length>0)return void this.app.workspace.revealLeaf(e[0]);const t=this.app.workspace.getLeaf("tab");yield t.setViewState({type:c,active:!0}),this.app.workspace.revealLeaf(t)})}refreshCalendarView(){this.app.workspace.getLeavesOfType(c).forEach(e=>{try{e.view.renderCalendar()}catch(e){console.error("Error refreshing calendar view:",e)}}),this.embedRenderers.forEach(e=>{try{e.refresh()}catch(e){console.error("Error refreshing calendar embed:",e)}})}getMonthName(e){return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e]}getDayName(e){return["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][e]}getWeekStart(e){const t=new Date(e),n=t.getDay(),i=1===this.settings.weekStartDay?t.getDate()-(0===n?6:n-1):t.getDate()-n;return new Date(t.setDate(i))}onunload(){this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.embedRenderers=[]}}exports.VIEW_TYPE_REAL_CALENDAR=c,exports.default=h;
